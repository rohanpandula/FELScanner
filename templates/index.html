<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FELScanner</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --bs-body-bg: #121212;
            --bs-body-color: #e0e0e0;
            --card-bg: #1e1e1e;
            --card-border: #333;
            --input-bg: #2d2d2d;
            --input-border: #444;
            --input-color: #e0e0e0;
            --stat-card-bg: #242424;
            --stat-card-hover-bg: #2a2a2a;
            --bg-color: #f8f9fa;
            --text-color: #212529;
            --card-border: #dee2e6;
            --input-border: #ced4da;
            --input-color: #212529;
        }

        [data-bs-theme="dark"] {
            --bg-color: #212529;
            --text-color: #f8f9fa;
            --card-bg: #2c3034;
            --card-border: #495057;
            --stat-card-bg: #343a40;
            --stat-card-hover-bg: #495057;
            --input-bg: #343a40;
            --input-border: #495057;
            --input-color: #e9ecef;
        }

        body {
            padding-top: 20px;
            padding-bottom: 40px;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", "Noto Sans", "Liberation Sans", Arial, sans-serif;
        }
        .container {
            max-width: 960px;
        }
        .setup-step {
            display: none;
        }
        .setup-step:first-child {
            display: block;
        }
        .dashboard-section {
            margin-bottom: 2rem;
        }
        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-weight: bold;
            text-transform: uppercase;
        }
        .status-badge.idle {
            background-color: #2d3748;
            color: #a0aec0;
        }
        .status-badge.scanning, .status-badge.verifying {
            background-color: #1a365d;
            color: #63b3ed;
        }
        .status-badge.monitoring {
            background-color: #1c4532;
            color: #68d391;
        }
        .status-badge.error {
            background-color: #742a2a;
            color: #fc8181;
        }
        .status-badge.completed {
            background-color: #1c4532;
            color: #68d391;
        }
        .form-section {
            margin-bottom: 1.5rem;
        }
        .stat-card {
            text-align: center;
            padding: 1rem;
            border-radius: 0.375rem;
            background-color: var(--stat-card-bg);
            margin-bottom: 1rem;
            border: 1px solid var(--card-border);
        }
        .stat-card h1 {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
            color: #fff;
        }
        .stat-card p {
            margin-bottom: 0;
            color: #9ca3af;
        }
        .stat-card.clickable {
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        .stat-card.clickable:before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.05);
            opacity: 0;
            transition: opacity 0.2s;
        }
        .stat-card.clickable:hover:before {
            opacity: 1;
        }
        .scan-status-container {
            border-radius: 0.375rem;
            margin-bottom: 1rem;
            padding: 1rem;
            background-color: var(--card-bg);
            border: 1px solid var(--card-border);
        }
        .scan-times {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            font-size: 0.875rem;
            color: #9ca3af;
        }
        .scan-times > div {
            flex: 1;
            min-width: 200px;
        }
        .scan-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        .change-item {
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            border-radius: 0.25rem;
            border-left: 3px solid;
        }
        .change-item.added {
            background-color: rgba(52, 211, 153, 0.1);
            border-left-color: #34d399;
        }
        .change-item.removed {
            background-color: rgba(239, 68, 68, 0.1);
            border-left-color: #ef4444;
        }
        .changes-tab-content {
            padding-top: 1rem;
        }
        .changes-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        .change-count {
            font-size: 0.875rem;
            color: #9ca3af;
        }
        .nav-link {
            color: var(--bs-body-color);
            opacity: 0.8;
        }
        .nav-link:hover,
        .nav-link:focus {
            color: var(--bs-body-color);
            opacity: 1;
        }
        .nav-link.active {
            color: #3182ce !important;
            opacity: 1;
        }
        .card {
            background-color: var(--card-bg);
            border-color: var(--card-border);
        }
        .card-header {
            background-color: rgba(0, 0, 0, 0.15);
            border-bottom: 1px solid var(--card-border);
        }
        .stat-card {
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.2);
            transition: transform 0.2s;
            background-color: var(--stat-card-bg);
        }
        .stat-card:hover {
            transform: translateY(-3px);
            background-color: var(--stat-card-hover-bg);
        }
        .form-control, .input-group-text {
            background-color: var(--input-bg);
            border-color: var(--input-border);
            color: var(--input-color);
        }
        .form-control:focus {
            background-color: var(--input-bg);
            color: var(--input-color);
        }
        .form-check-input {
            background-color: var(--input-bg);
            border-color: var(--input-border);
        }
        .table {
            color: var(--bs-body-color);
            border-color: var(--card-border);
        }
        .alert-info {
            background-color: #1a365d;
            color: #63b3ed;
            border-color: #2a4365;
        }
        .list-group-item {
            background-color: var(--card-bg);
            border-color: var(--card-border);
            color: var(--bs-body-color);
        }
        .form-text {
            color: #9ca3af;
        }
        
        /* Toast styling */
        .toast {
            background-color: var(--card-bg);
            border: 1px solid var(--card-border);
            color: var(--text-color);
        }
        .toast-header {
            border-bottom: 1px solid var(--card-border);
        }
        .toast-container {
            z-index: 1100;
        }
        
        /* Sorting styles */
        .sortable {
            cursor: pointer;
            position: relative;
            padding-right: 25px; /* Add space for sort icon */
        }
        .sortable:hover {
            background-color: rgba(128, 128, 128, 0.1);
        }
        .sortable .fa-sort {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            opacity: 0.4;
        }
        .sortable .fa-sort-up,
        .sortable .fa-sort-down {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            opacity: 1;
            color: #3182ce; /* Bright blue color for sort indicators */
        }
        .sortable.sort-asc .fa-sort,
        .sortable.sort-desc .fa-sort {
            display: none;
        }
        .sort-asc, .sort-desc {
            font-weight: bold;
            color: #3182ce;
        }
        /* Hide columns when needed */
        .size-col {
            display: table-cell;
        }
        .alert {
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 4px;
        }
        .loading-spinner {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            margin-right: 5px;
            border: 0.15em solid currentColor;
            border-right-color: transparent;
            border-radius: 50%;
            -webkit-animation: spinner-border .75s linear infinite;
            animation: spinner-border .75s linear infinite;
            vertical-align: middle;
        }
        /* Table styling */
        .table th.sortable {
            cursor: pointer;
            position: relative;
        }
        .table th.sortable:hover {
            background-color: rgba(0,0,0,0.05);
        }
        .table th.sort-asc::after {
            content: "▲";
            position: absolute;
            right: 8px;
            color: #007bff;
        }
        .table th.sort-desc::after {
            content: "▼";
            position: absolute;
            right: 8px;
            color: #007bff;
        }
        /* Custom column widths for movie table */
        .year-col {
            width: 70px;
        }
        .dv-profile-col {
            width: 90px;
        }
        .audio-col {
            width: 150px;
        }
        .bitrate-col {
            width: 90px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="mb-4">
            <h1 class="text-center">FELScanner</h1>
            <p class="text-center text-muted">Scan your Plex library for Dolby Vision and TrueHD Atmos content</p>
        </header>
        
        <!-- Setup Wizard -->
        <div id="setup-wizard" style="display: {% if setup_completed %}none{% else %}block{% endif %};">
            <div class="card">
                <div class="card-header">
                    <h5>Setup Wizard</h5>
                </div>
                <div class="card-body">
                    <!-- Step 1: Plex Connection -->
                    <div class="setup-step">
                        <h4>Step 1: Plex Connection</h4>
                        <p>Enter your Plex server details to connect to your library.</p>
                        
                        <div class="mb-3">
                            <label for="plex-url" class="form-label">Plex URL</label>
                            <input type="text" class="form-control" id="plex-url" placeholder="http://localhost:32400">
                            <div class="form-text">The URL to your Plex server, including port (usually 32400)</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="plex-token" class="form-label">Plex Token</label>
                            <input type="text" class="form-control" id="plex-token" placeholder="Your Plex authentication token">
                            <div class="form-text">Your Plex authentication token <a href="https://support.plex.tv/articles/204059436-finding-an-authentication-token-x-plex-token/" target="_blank">How to find your token</a></div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="library-name" class="form-label">Movie Library Name</label>
                            <input type="text" class="form-control" id="library-name" placeholder="Movies">
                            <div class="form-text">The exact name of your movie library in Plex</div>
                        </div>
                        
                        <div class="alert alert-success" id="plex-success" style="display: none;"></div>
                        <div class="alert alert-danger" id="plex-error" style="display: none;"></div>
                        
                        <div class="mt-3">
                            <button type="button" class="btn btn-primary" id="test-plex-btn">Test Connection</button>
                            <button type="button" class="btn btn-success next-step" style="display: none;">Next</button>
                        </div>
                    </div>
                    
                    <!-- Step 2: Collection Settings -->
                    <div class="setup-step">
                        <h4>Step 2: Collection Settings</h4>
                        <p>Configure the collection names for different content types.</p>
                        
                        <div class="mb-3">
                            <label for="collection-dv" class="form-label">Dolby Vision Collection</label>
                            <input type="text" class="form-control" id="collection-dv" value="All Dolby Vision">
                            <div class="form-text">Name for the collection containing all Dolby Vision content</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="collection-p7" class="form-label">Profile 7 FEL Collection</label>
                            <input type="text" class="form-control" id="collection-p7" value="DV FEL Profile 7">
                            <div class="form-text">Name for the collection containing Profile 7 FEL content</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="collection-atmos" class="form-label">TrueHD Atmos Collection</label>
                            <input type="text" class="form-control" id="collection-atmos" value="TrueHD Atmos">
                            <div class="form-text">Name for the collection containing TrueHD Atmos audio</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="reports-size" class="form-label">Maximum Report Storage (MB)</label>
                            <input type="number" class="form-control" id="reports-size" value="5" min="1">
                            <div class="form-text">Maximum disk space to use for storing reports (in MB)</div>
                        </div>
                        
                        <div class="mt-3">
                            <button type="button" class="btn btn-secondary prev-step">Previous</button>
                            <button type="button" class="btn btn-success next-step">Next</button>
                        </div>
                    </div>
                    
                    <!-- Step 3: Notifications -->
                    <div class="setup-step">
                        <h4>Step 3: Notifications (Optional)</h4>
                        <p>Configure Telegram notifications for updates.</p>
                        
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="telegram-enabled">
                            <label class="form-check-label" for="telegram-enabled">
                                Enable Telegram notifications
                            </label>
                        </div>
                        
                        <div id="telegram-settings" style="display: none;">
                            <div class="mb-3">
                                <label for="telegram-token" class="form-label">Bot Token</label>
                                <input type="text" class="form-control" id="telegram-token">
                                <div class="form-text">Your Telegram bot token from BotFather</div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="telegram-chat-id" class="form-label">Chat ID</label>
                                <input type="text" class="form-control" id="telegram-chat-id">
                                <div class="form-text">Your Telegram chat ID or group ID</div>
                            </div>
                            
                            <div class="alert alert-success" id="telegram-success" style="display: none;"></div>
                            <div class="alert alert-danger" id="telegram-error" style="display: none;"></div>
                            
                            <div class="mb-3">
                                <button type="button" class="btn btn-primary" id="test-telegram-btn">Test Telegram</button>
                            </div>
                        </div>
                        
                        <div class="mt-3">
                            <button type="button" class="btn btn-secondary prev-step">Previous</button>
                            <button type="button" class="btn btn-success next-step">Complete Setup</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Main Dashboard -->
        <div id="main-dashboard" style="display: {% if setup_completed %}block{% else %}none{% endif %};">
            <ul class="nav nav-tabs mb-4" id="dashboard-tabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="home-tab" data-bs-toggle="tab" data-bs-target="#home" type="button" role="tab" aria-controls="home" aria-selected="true">Dashboard</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="reports-tab" data-bs-toggle="tab" data-bs-target="#reports" type="button" role="tab" aria-controls="reports" aria-selected="false">Reports</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="iptscanner-tab" data-bs-toggle="tab" data-bs-target="#iptscanner" type="button" role="tab" aria-controls="iptscanner" aria-selected="false">IPTScanner</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings" type="button" role="tab" aria-controls="settings" aria-selected="false">Settings</button>
                </li>
            </ul>
            
            <div class="tab-content">
                <!-- Home Tab -->
                <div class="tab-pane fade show active" id="home" role="tabpanel" aria-labelledby="home-tab">
                    <!-- Status Section -->
                    <div class="dashboard-section">
                        <h4>Status</h4>
                        <div class="card">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <p>Current Status: <span id="status-badge" class="status-badge idle">Idle</span></p>
                                        <p>Last Scan: <span id="last-scan-time">Never</span></p>
                                        <div id="next-scan-container" style="display: none;">
                                            <p>Next Scan: <span id="next-scan-time">Unknown</span></p>
                                        </div>
                                    </div>
                                    <div class="col-md-6 text-end">
                                        <div class="d-grid gap-2 d-md-flex justify-content-md-end action-buttons">
                                            <button id="start-scan-btn" class="btn btn-primary me-md-2 mb-2">Start Scan</button>
                                            <button id="verify-collections-btn" class="btn btn-secondary me-md-2 mb-2">Verify Collections</button>
                                            <button id="start-monitor-btn" class="btn btn-success mb-2">Start Monitor</button>
                                            <button id="stop-monitor-btn" class="btn btn-danger mb-2" style="display: none;">Stop Monitor</button>
                                        </div>
                                    </div>
                                </div>
                                
                                <div id="scan-progress-container" class="progress-container" style="display: none;">
                                    <div class="progress">
                                        <div id="scan-progress" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Statistics Section -->
                    <div class="dashboard-section">
                        <h4>Statistics</h4>
                        <div class="row">
                            <div class="col-md-3">
                                <div class="stat-card">
                                    <h1 id="total-movies">0</h1>
                                    <p>Total Movies</p>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stat-card clickable" data-collection="dv">
                                    <h1 id="dv-movies">0</h1>
                                    <p>Dolby Vision</p>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stat-card clickable" data-collection="p7">
                                    <h1 id="p7-movies">0</h1>
                                    <p>Profile 7 FEL</p>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stat-card clickable" data-collection="atmos">
                                    <h1 id="atmos-movies">0</h1>
                                    <p>TrueHD Atmos</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Radarr Section -->
                    <div class="dashboard-section">
                        <h4>Radarr Integration</h4>
                        <div class="card">
                            <div class="card-body">
                                <div class="d-flex flex-wrap justify-content-between align-items-center mb-3">
                                    <div>
                                        <span id="radarr-status-badge" class="badge bg-secondary">Disabled</span>
                                        <small id="radarr-status-message" class="text-muted ms-2">Not configured</small>
                                    </div>
                                    <div>
                                        <button type="button" id="radarr-refresh-btn" class="btn btn-outline-light btn-sm">
                                            <i class="fas fa-sync-alt"></i> Refresh
                                        </button>
                                    </div>
                                </div>
                                <div class="row text-center radarr-hero-row">
                                    <div class="col-md-4 col-sm-4 col-12 mb-3">
                                        <div class="radarr-hero">
                                            <div class="radarr-hero-value" id="radarr-matched-count">0</div>
                                            <div class="radarr-hero-label">Matched Titles</div>
                                        </div>
                                    </div>
                                    <div class="col-md-4 col-sm-4 col-12 mb-3">
                                        <div class="radarr-hero">
                                            <div class="radarr-hero-value" id="radarr-monitored-count">0</div>
                                            <div class="radarr-hero-label">Monitored in Radarr</div>
                                        </div>
                                    </div>
                                    <div class="col-md-4 col-sm-4 col-12 mb-3">
                                        <div class="radarr-hero">
                                            <div class="radarr-hero-value" id="radarr-missing-count">0</div>
                                            <div class="radarr-hero-label">Needs Radarr</div>
                                        </div>
                                    </div>
                                </div>
                                <div id="radarr-selected-movie" class="radarr-selected mt-3">
                                    <h5 class="d-flex align-items-center justify-content-between">
                                        <span id="radarr-selected-title">Select a movie to check Radarr status</span>
                                        <span class="radarr-action-buttons">
                                            <button type="button" id="radarr-check-btn" class="btn btn-primary btn-sm" disabled>
                                                <i class="fas fa-search"></i> Check Radarr
                                            </button>
                                            <button type="button" id="radarr-add-btn" class="btn btn-success btn-sm" disabled>
                                                <i class="fas fa-plus"></i> Add to Radarr
                                            </button>
                                            <a id="radarr-view-link" href="#" target="_blank" rel="noopener" class="btn btn-outline-secondary btn-sm" style="display:none;">
                                                <i class="fas fa-external-link-alt"></i> View in Radarr
                                            </a>
                                        </span>
                                    </h5>
                                    <p id="radarr-selected-status" class="small text-muted mb-0"></p>
                                    <div id="radarr-release-container" class="radarr-releases mt-4">
                                        <div class="d-flex flex-wrap justify-content-between align-items-start gap-3">
                                            <div>
                                                <h6 class="mb-1">Radarr Release Search</h6>
                                                <div id="radarr-release-summary" class="text-muted small">Select a movie to begin.</div>
                                            </div>
                                            <div class="btn-group radarr-release-actions" role="group">
                                                <button type="button" id="radarr-release-search-btn" class="btn btn-outline-primary btn-sm" disabled>
                                                    <i class="fas fa-search"></i> Search Releases
                                                </button>
                                                <button type="button" id="radarr-release-refresh-btn" class="btn btn-outline-secondary btn-sm" disabled>
                                                    <i class="fas fa-sync-alt"></i> Refresh Search
                                                </button>
                                            </div>
                                        </div>
                                        <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mt-3">
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" id="radarr-filter-ipt" disabled>
                                                <label class="form-check-label" for="radarr-filter-ipt">Only show FEL/IPT matches</label>
                                            </div>
                                            <small id="radarr-filter-message" class="text-muted"></small>
                                        </div>
                                        <div id="radarr-release-empty" class="radarr-release-empty text-muted small mt-3">Run a release search to see available results.</div>
                                        <ul id="radarr-release-list" class="list-group list-group-flush radarr-release-list mt-2"></ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Collection Changes Section -->
                    <div class="dashboard-section">
                        <h4>Collection Changes</h4>
                        <div id="no-changes-alert" class="alert alert-info">
                            <i class="fas fa-info-circle"></i> No recent changes to collections. 
                            <small>This means all movies are already properly categorized in their respective collections.</small>
                        </div>
                        
                        <div id="changes-container" class="mt-4" style="display: none;">
                            <div class="card">
                                <div class="card-header">
                                    <h5>Collection Changes</h5>
                                </div>
                                <div class="card-body">
                                    <div id="collection-tabs" class="nav nav-tabs mb-3">
                                        <!-- Tabs will be inserted here by JavaScript -->
                                    </div>
                                    <div id="collection-contents">
                                        <!-- Tab content will be inserted here by JavaScript -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Reports Tab -->
                <div class="tab-pane fade" id="reports" role="tabpanel" aria-labelledby="reports-tab">
                    <h4>Scan Reports</h4>
                    <div class="card">
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Filename</th>
                                            <th>Size</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="reports-table">
                                        <tr>
                                            <td colspan="4" class="text-center">Loading reports...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <button id="view-all-reports" class="btn btn-outline-primary">View All Reports</button>
                        </div>
                    </div>
                </div>
                
                <!-- IPTScanner Tab -->
                <div class="tab-pane fade" id="iptscanner" role="tabpanel" aria-labelledby="iptscanner-tab">
                    <h4>IPTorrents Monitor</h4>
                    
                    <div class="dashboard-section">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">Torrent Finder</h5>
                                <div>
                                    <button id="iptscanner-refresh" class="btn btn-primary btn-sm">
                                        <i class="fas fa-sync-alt"></i> Refresh
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="row mb-3">
                                    <div class="col-md-4">
                                        <div class="card bg-dark">
                                            <div class="card-body">
                                                <h6>Search Term</h6>
                                                <p id="ipt-search-term" class="mb-0 text-info">Loading...</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="card bg-dark">
                                            <div class="card-body">
                                                <h6>Last Check</h6>
                                                <p id="ipt-last-check" class="mb-0 text-info">Loading...</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="card bg-dark">
                                            <div class="card-body">
                                                <div class="d-flex align-items-center mb-3">
                                                    <div class="rounded-circle bg-dark d-flex justify-content-center align-items-center" style="width: 36px; height: 36px;">
                                                        <i class="fas fa-clock text-info"></i>
                                                    </div>
                                                    <div class="ms-3">
                                                        <h6 class="fw-bold mb-0">Schedule</h6>
                                                        <p id="ipt-schedule" class="text-muted mb-0 clickable-setting" title="Click to edit schedule">Every 2 hours <i class="fas fa-edit ms-1 text-secondary"></i></p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th width="5%">#</th>
                                                <th width="50%">Title</th>
                                                <th width="10%">Size</th>
                                                <th width="15%">Seeds/Leech</th>
                                                <th width="10%">Added</th>
                                                <th width="10%">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="ipt-torrents-table">
                                            <tr>
                                                <td colspan="6" class="text-center">Loading torrents...</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                
                                <div id="ipt-no-torrents" class="alert alert-info" style="display:none;">
                                    <i class="fas fa-info-circle"></i> No torrents found matching your search criteria.
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="dashboard-section">
                        <h5>Activity Log</h5>
                        <div class="card">
                            <div class="card-body">
                                <div id="ipt-log" class="bg-dark p-3 rounded" style="max-height: 200px; overflow-y: auto;">
                                    <div class="text-muted">No activity recorded yet.</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Settings Tab -->
                <div class="tab-pane fade" id="settings" role="tabpanel" aria-labelledby="settings-tab">
                    <h4>Settings</h4>
                    <div class="card">
                        <div class="card-body">
                            <form id="settings-form">
                                <!-- Plex Connection Settings -->
                                <div class="form-section">
                                    <h5>Plex Connection</h5>
                                    <div class="mb-3">
                                        <label for="settings-plex-url" class="form-label">Plex URL</label>
                                        <input type="text" class="form-control" id="settings-plex-url">
                                    </div>
                                    <div class="mb-3">
                                        <label for="settings-plex-token" class="form-label">Plex Token</label>
                                        <input type="text" class="form-control" id="settings-plex-token">
                                    </div>
                                    <div class="mb-3">
                                        <label for="settings-library-name" class="form-label">Movie Library Name</label>
                                        <input type="text" class="form-control" id="settings-library-name">
                                    </div>
                                </div>
                                
                                <!-- Collection Settings -->
                                <div class="form-section">
                                    <h5>Collections</h5>
                                    <div class="mb-3">
                                        <label for="settings-collection-dv" class="form-label">Dolby Vision Collection</label>
                                        <div class="input-group">
                                            <div class="input-group-text">
                                                <input class="form-check-input mt-0" type="checkbox" id="settings-enable-dv" checked>
                                            </div>
                                            <input type="text" class="form-control" id="settings-collection-dv">
                                        </div>
                                        <div class="form-text">Enable/disable and rename the Dolby Vision collection</div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="settings-collection-p7" class="form-label">Profile 7 FEL Collection</label>
                                        <div class="input-group">
                                            <div class="input-group-text">
                                                <input class="form-check-input mt-0" type="checkbox" id="settings-enable-p7" checked>
                                            </div>
                                            <input type="text" class="form-control" id="settings-collection-p7">
                                        </div>
                                        <div class="form-text">Enable/disable and rename the Profile 7 FEL collection</div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="settings-collection-atmos" class="form-label">TrueHD Atmos Collection</label>
                                        <div class="input-group">
                                            <div class="input-group-text">
                                                <input class="form-check-input mt-0" type="checkbox" id="settings-enable-atmos" checked>
                                            </div>
                                            <input type="text" class="form-control" id="settings-collection-atmos">
                                        </div>
                                        <div class="form-text">Enable/disable and rename the TrueHD Atmos collection</div>
                                    </div>
                                </div>
                                
                                <!-- General Settings -->
                                <div class="form-section">
                                    <h5>General Settings</h5>
                                    <div class="mb-3">
                                        <label for="settings-reports-size" class="form-label">Maximum Reports Size (MB)</label>
                                        <input type="number" class="form-control" id="settings-reports-size" min="1">
                                    </div>
                                    <div class="mb-3">
                                        <label for="settings-scan-frequency" class="form-label">Scan Frequency (hours)</label>
                                        <input type="number" class="form-control" id="settings-scan-frequency" min="1">
                                        <div class="form-text">How often to scan in monitor mode</div>
                                    </div>
                                    <div class="mb-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="settings-use-whole-numbers" checked>
                                            <label class="form-check-label" for="settings-use-whole-numbers">
                                                Use whole numbers for sizes and bitrates
                                            </label>
                                            <div class="form-text">When enabled, all sizes and bitrates will be rounded to whole numbers (e.g., "45 Mbps" instead of "45.2 Mbps")</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Radarr Settings -->
                                <div class="form-section">
                                    <h5>Radarr Integration</h5>
                                    <p class="form-text">Connect FELScanner to Radarr to monitor which titles are already managed.</p>
                                    <div class="row g-3 align-items-end">
                                        <div class="col-md-6">
                                            <label for="settings-radarr-url" class="form-label">Radarr Base URL</label>
                                            <input type="text" class="form-control" id="settings-radarr-url" placeholder="http://localhost:7878">
                                        </div>
                                        <div class="col-md-4">
                                            <label for="settings-radarr-api-key" class="form-label">API Key</label>
                                            <input type="password" class="form-control" id="settings-radarr-api-key">
                                        </div>
                                        <div class="col-md-2 d-grid">
                                            <button type="button" id="test-radarr-btn" class="btn btn-outline-primary">
                                                <i class="fas fa-plug"></i> Test
                                            </button>
                                        </div>
                                    </div>
                                    <div class="row g-3 mt-2">
                                        <div class="col-md-6">
                                            <label for="settings-radarr-root-folder" class="form-label">Root Folder</label>
                                            <select class="form-select" id="settings-radarr-root-folder">
                                                <option value="">Select a root folder</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <label for="settings-radarr-quality-profile" class="form-label">Quality Profile</label>
                                            <select class="form-select" id="settings-radarr-quality-profile">
                                                <option value="">Select a quality profile</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="form-check form-switch mt-3">
                                        <input class="form-check-input" type="checkbox" id="settings-radarr-auto-import">
                                        <label class="form-check-label" for="settings-radarr-auto-import">
                                            Automatically monitor new additions when adding to Radarr
                                        </label>
                                    </div>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="settings-radarr-dry-run" checked>
                                        <label class="form-check-label" for="settings-radarr-dry-run">
                                            Dry run mode (preview add actions without sending to Radarr)
                                        </label>
                                    </div>
                                    <div id="settings-radarr-test-result" class="form-text text-muted mt-2"></div>
                                </div>

                                <!-- IPTScanner Settings -->
                                <div class="form-section">
                                    <h5>IPTScanner Settings</h5>
                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="checkbox" id="settings-ipt-enabled" checked>
                                        <label class="form-check-label" for="settings-ipt-enabled">
                                            Enable IPTorrents Scanner
                                        </label>
                                    </div>
                                    
                                    <div id="settings-ipt-container">
                                        <div class="mb-3">
                                            <label for="settings-ipt-search" class="form-label">Search Term</label>
                                            <input type="text" class="form-control" id="settings-ipt-search" value="BL+EL+RPU">
                                            <div class="form-text">The search term to look for on IPTorrents</div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="settings-ipt-check-interval" class="form-label">Check Interval</label>
                                            <select class="form-control" id="settings-ipt-check-interval">
                                                <option value="15min">Every 15 minutes</option>
                                                <option value="30min">Every 30 minutes</option>
                                                <option value="1hour">Every hour</option>
                                                <option value="2hour" selected>Every 2 hours</option>
                                                <option value="6hour">Every 6 hours</option>
                                                <option value="12hour">Every 12 hours</option>
                                                <option value="1day">Once daily</option>
                                            </select>
                                            <div class="form-text">How often to check for new torrents</div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="settings-ipt-headless" class="form-label">Browser Mode</label>
                                            <select class="form-control" id="settings-ipt-headless">
                                                <option value="true" selected>Headless (invisible)</option>
                                                <option value="false">Visible browser</option>
                                            </select>
                                            <div class="form-text">Whether to show the browser window when scanning</div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="settings-ipt-data-path" class="form-label">Data Storage Path</label>
                                            <input type="text" class="form-control" id="settings-ipt-data-path">
                                            <div class="form-text">Path to store IPTScanner data files</div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="settings-ipt-userdata-dir" class="form-label">Browser Profile Path</label>
                                            <input type="text" class="form-control" id="settings-ipt-userdata-dir">
                                            <div class="form-text">Path to store browser profile data</div>
                                        </div>
                                        
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" id="settings-ipt-debug">
                                            <label class="form-check-label" for="settings-ipt-debug">
                                                Enable debug mode
                                            </label>
                                        </div>
                                        
                                        <div class="card bg-dark mb-3">
                                            <div class="card-body">
                                                <h6 class="card-title">IPTorrents Login</h6>
                                                <div id="ipt-cookie-status" class="alert alert-info mb-3" style="display: none;">
                                                    <i class="fas fa-cookie"></i> <span id="ipt-cookie-status-text">Checking cookie status...</span>
                                                </div>
                                                <p class="text-warning">
                                                    <i class="fas fa-exclamation-triangle"></i> You'll need to provide cookies for IPTorrents login.
                                                </p>
                                                <div class="mb-3">
                                                    <label for="settings-ipt-uid" class="form-label">UID Cookie</label>
                                                    <input type="text" class="form-control" id="settings-ipt-uid" placeholder="Enter your 'uid' cookie value">
                                                </div>
                                                <div class="mb-3">
                                                    <label for="settings-ipt-pass" class="form-label">Pass Cookie</label>
                                                    <input type="text" class="form-control" id="settings-ipt-pass" placeholder="Enter your 'pass' cookie value">
                                                </div>
                                                <button id="test-ipt-login" class="btn btn-outline-primary btn-sm">Test Login</button>
                                                <button id="test-run-ipt-scanner" class="btn btn-outline-secondary btn-sm ml-2">Test Run Scanner</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Notification Settings -->
                                <div class="form-section">
                                    <h5>Notification Settings</h5>
                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="checkbox" id="settings-telegram-enabled">
                                        <label class="form-check-label" for="settings-telegram-enabled">
                                            Enable Telegram notifications
                                        </label>
                                    </div>
                                    
                                    <div id="settings-telegram-container" style="display: none;">
                                        <div class="mb-3">
                                            <label for="settings-telegram-token" class="form-label">Bot Token</label>
                                            <input type="text" class="form-control" id="settings-telegram-token">
                                        </div>
                                        <div class="mb-3">
                                            <label for="settings-telegram-chat-id" class="form-label">Chat ID</label>
                                            <input type="text" class="form-control" id="settings-telegram-chat-id">
                                        </div>
                                        
                                        <!-- Add Telegram test button and alerts -->
                                        <div class="mb-3">
                                            <div class="alert alert-success" id="settings-telegram-success" style="display: none;"></div>
                                            <div class="alert alert-danger" id="settings-telegram-error" style="display: none;"></div>
                                            <button type="button" class="btn btn-primary" id="settings-test-telegram-btn">
                                                <i class="fas fa-paper-plane"></i> Test Telegram Connection
                                            </button>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <h6>Notification Preferences</h6>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="settings-notify-all">
                                                <label class="form-check-label" for="settings-notify-all">
                                                    Notify for all scan updates
                                                </label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="settings-notify-new">
                                                <label class="form-check-label" for="settings-notify-new">
                                                    Notify for new movies
                                                </label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="settings-notify-dv">
                                                <label class="form-check-label" for="settings-notify-dv">
                                                    Notify for Dolby Vision updates
                                                </label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="settings-notify-p7">
                                                <label class="form-check-label" for="settings-notify-p7">
                                                    Notify for Profile 7 FEL updates
                                                </label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="settings-notify-atmos">
                                                <label class="form-check-label" for="settings-notify-atmos">
                                                    Notify for TrueHD Atmos updates
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mt-4">
                                    <button type="button" id="save-settings-btn" class="btn btn-primary">Save Settings</button>
                                    <button type="button" id="reset-settings-btn" class="btn btn-danger">Reset to Default</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Toast container for notifications -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <!-- Toasts will be inserted here dynamically -->
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // Initialize the setup state directly from server data
      document.addEventListener('DOMContentLoaded', function() {
        const setupCompleted = {{ setup_completed|tojson }};
        console.log('Initial setup_completed from server:', setupCompleted);
        
        // Set initial visibility
        document.getElementById('setup-wizard').style.display = setupCompleted ? 'none' : 'block';
        document.getElementById('main-dashboard').style.display = setupCompleted ? 'block' : 'none';
      });
    </script>
    <script src="/static/js/main.js"></script>
    
    <!-- Movie List Modal -->
    <div class="modal fade" id="movieListModal" tabindex="-1" aria-labelledby="movieListModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="movieListModalLabel">Movie List</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="modal-loading text-center py-5" style="display: none;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-3">Loading movie list...</p>
                    </div>
                    <div class="movie-list-content">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th class="sortable" data-sort="title">Title <i class="fa fa-sort"></i></th>
                                        <th class="sortable" data-sort="year">Year <i class="fa fa-sort"></i></th>
                                        <th class="dv-profile-col sortable" data-sort="profile">Profile <i class="fa fa-sort"></i></th>
                                        <th class="audio-col sortable" data-sort="audio">Audio <i class="fa fa-sort"></i></th>
                                        <th class="bitrate-col sortable" data-sort="bitrate">Bitrate <i class="fa fa-sort"></i></th>
                                        <th class="size-col sortable" data-sort="size">Size <i class="fa fa-sort"></i></th>
                                        <th class="sortable" data-sort="added">Added <i class="fa fa-sort"></i></th>
                                    </tr>
                                </thead>
                                <tbody id="movie-list-table">
                                    <!-- Movies will be inserted here -->
                                </tbody>
                            </table>
                        </div>
                        <div id="no-movies-message" class="alert alert-info" style="display: none;">
                            No movies found in this collection.
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
